% reviewresponse.sty

\ProvidesPackage{reviewresponse}[2025/09/18 Review response environments]

% Required packages
\RequirePackage{xifthen}
\RequirePackage{xcolor}
\RequirePackage{mdframed}
\RequirePackage{fancyhdr}
% Ensure enough space for the header (set after all packages)
\AtBeginDocument{%
  \setlength{\headheight}{14pt}% ensure enough space for header/foot
  % Make header/foot span full paper width and center content physically
  \fancyhfoffset[L]{\dimexpr -1in - \oddsidemargin\relax}
  \fancyhfoffset[R]{\dimexpr -1in - \evensidemargin\relax}
  \setlength{\headwidth}{\paperwidth}%
  % R-prefixed numbering for response letter artifacts
  \renewcommand*{\theequation}{A\arabic{equation}}
  \renewcommand*{\thefigure}{A\arabic{figure}}
  \renewcommand*{\thetable}{A\arabic{table}}
  \renewcommand*{\figurename}{Fig.}
  \renewcommand*{\tablename}{Tab.}%
}

% Separate top-level counters for editors and reviewers (avoid name clash with biblatex's internal macros)
\newcounter{rreditor}
\newcounter{rrreviewer}

% Per-editor and per-reviewer comment counters
\newcounter{edcomment}[rreditor]
\newcounter{revcomment}[rrreviewer]

% Answer anchor counters (mirror current Q numbering for labels)
\newcounter{edansref}[rreditor]
\newcounter{revansref}[rrreviewer]

% Numbering representations with E / R prefixes
\renewcommand{\theedcomment}{E\arabic{rreditor}.\arabic{edcomment}}
\renewcommand{\therevcomment}{R\arabic{rrreviewer}.\arabic{revcomment}}
\renewcommand{\theedansref}{E\arabic{rreditor}.\arabic{edcomment}}
\renewcommand{\therevansref}{R\arabic{rrreviewer}.\arabic{revcomment}}

% Internal context flag: E or R (defaults to R when a reviewer section starts)
\newcommand{\RR@context}{R}

% Editor section environment command
\newcommand{\editorsection}[1]{%
  \stepcounter{rreditor}%
  \setcounter{edcomment}{0}%
  \setcounter{edansref}{0}%
  \def\RR@context{E}%
  \section*{#1}%
  	\thispagestyle{fancy}%
}

% Reviewer section environment command
\newcommand{\reviewersection}[1]{%
  \stepcounter{rrreviewer}%
  \setcounter{revcomment}{0}%
  \setcounter{revansref}{0}%
  \def\RR@context{R}%
  \section*{#1}%
  	\thispagestyle{fancy}%
}

% Question environment (boxed, label optional)
\newenvironment{question}[1][]%
{%
  % Step appropriate counter based on context
  \ifthenelse{\equal{\RR@context}{E}}{\refstepcounter{edcomment}}{\refstepcounter{revcomment}}%
  % Place label early to avoid affecting paragraph indentation (after refstepcounter)
  \ifthenelse{\equal{#1}{}}{}{\label{#1}}%
  \begin{mdframed}[backgroundcolor=gray!10, linecolor=gray!60, topline=true, bottomline=true, leftline=true, rightline=true, skipabove=0pt, skipbelow=0pt]%
  \setlength{\parindent}{0pt}%
  \ifthenelse{\equal{\RR@context}{E}}{\textbf{Question~\theedcomment:}}{\textbf{Question~\therevcomment:}}%
  \par\noindent\ignorespaces
}
{\end{mdframed}}

% Answer environment (boxed, label optional)
\newenvironment{answer}[1][]%
{%
  % Step answer anchor counter (mirrors last question number)
  \ifthenelse{\equal{\RR@context}{E}}{\refstepcounter{edansref}}{\refstepcounter{revansref}}%
  % Label early
  \ifthenelse{\equal{#1}{}}{}{\label{#1}}%
  \begin{mdframed}[backgroundcolor=blue!5, linecolor=blue!30, topline=true, bottomline=true, leftline=true, rightline=true, skipabove=0pt, skipbelow=0pt]%
  \setlength{\parindent}{0pt}%
  \ifthenelse{\equal{\RR@context}{E}}{\textbf{Answer~\theedcomment:}}{\textbf{Answer~\therevcomment:}}%
  \par\noindent\ignorespaces
}
{\end{mdframed}\vspace{1.5em}}

% Reference command for questions/answers (works for both E and R labels)
% We do not distinguish here; the stored counter representation already includes E/R.
\newcommand{\qref}[1]{Question~\ref{#1}}
\newcommand{\aref}[1]{Answer~\ref{#1}}

% Short reference commands for figures and tables (use current names)
\newcommand{\figref}[1]{\figurename~\ref{#1}}
\newcommand{\tabref}[1]{\tablename~\ref{#1}}
% Alias preferred name \tableref to \tabref
\newcommand{\tableref}[1]{\tabref{#1}}

% Utility: short Q/A for tight comments
\newcommand{\shortquestion}[2][]{%
  \ifthenelse{\equal{\RR@context}{E}}{\refstepcounter{edcomment}}{\refstepcounter{revcomment}}%
  \ifthenelse{\equal{\RR@context}{E}}{\textbf{Question~\theedcomment:}}{\textbf{Question~\therevcomment:}}%
  \ifthenelse{\equal{#1}{}}{}{\label{#1}}%
  {#2}\par
}
\newcommand{\shortanswer}[2][]{%
  \ifthenelse{\equal{\RR@context}{E}}{\refstepcounter{edansref}}{\refstepcounter{revansref}}%
  \ifthenelse{\equal{\RR@context}{E}}{\textbf{Answer~\theedcomment:}}{\textbf{Answer~\therevcomment:}}%
  \ifthenelse{\equal{#1}{}}{}{\label{#1}}%
  {#2}\par
}

\makeatletter
% Metadata commands (setters)
\newcommand{\paperid}[1]{\def\@paperid{#1}}
\newcommand{\papertitle}[2][]{\def\@papertitle{#2}\ifthenelse{\equal{#1}{}}{\def\@papertitleshort{#2}}{\def\@papertitleshort{#1}}}
\def\@paperid{}
\def\@papertitle{}
\def\@papertitleshort{}
% Public print commands (do NOT redefine in document)
\newcommand{\printpaperid}{\@paperid}
\newcommand{\printpapertitle}{\@papertitle}
\newcommand{\printpapertitleshort}{\@papertitleshort}

% Footer-only configuration (bottom center page count)
\fancyhf{} % clear all header and footer fields
\renewcommand{\headrulewidth}{0pt} % no line in header
\renewcommand{\footrulewidth}{0pt} % no line in footer
\cfoot{Page\;\thepage}
% Apply same footer for 'plain' pages (e.g., after \section*)
\fancypagestyle{plain}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0pt}
  \cfoot{Page\;\thepage}%
}
\makeatother

% End of reviewresponse.sty